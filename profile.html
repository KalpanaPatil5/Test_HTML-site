<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile Page</title>
  <!-- Favicon-->
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
  <!-- Bootstrap icons-->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css"
    rel="stylesheet" type="text/css" />
  <!-- Google fonts-->
  <link
    href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic"
    rel="stylesheet" type="text/css" />
  <!-- Core theme CSS (includes Bootstrap)-->
  <link href="css/styles.css" rel="stylesheet" />
  <link href="css/profile.css" rel="stylesheet"/>
</head>

<body>
  <nav>
    <ul>
      <li class="dropdown">
        <a href="#" class="dropdown-toggle">Settings</a>
        <ul class="dropdown-content">
          <li><a href="#" data-bs-toggle="modal" data-bs-target="#profileModal">Edit Profile</a></li>
          <li><a href="index.html">Logout</a></li>
        </ul>
      </li>
    </ul>
  </nav>
  
  <div class="container" style="background-color: transparent; font-family: cursive; color: color-mix(in hwb increasing hue, red 45%, orange 30%);">
    <h1>HI, <span id="username"></span> Welcome to Our Website!</h1>
  </div> 

  <div id="notification" class="alert"></div>
  
  <!-- Modal  Edit Profile -->
  <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Edit Profile</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal"
            aria-label="Close"></button>
            </div>
            <div class="modal-body">
            <div class="form-wrap">
                <form id="profileForm" class="row g-3 needs-validation" novalidate>
                <div class="col-md-12">
                    <label for="userid" class="form-label"></label>
                    <input type="hidden" class="form-control" id="userid" name="userid">
                </div>
                <div class="col-md-12">
                    <div class="text-left">
                        <label for="firstName" class="form-label">First Name</label>
                    </div>
                    <input type="text" class="form-control" id="firstName" name="firstName" required>
                </div>
                <div class="col-md-12">
                    <div class="text-left">
                        <label for="lastName" class="form-label">Last Name</label>
                    </div>
                    <input type="text" class="form-control" id="lastName" name="lastName" required>
                </div>
                <div class="col-md-12">
                    <div class="text-left">
                        <label for="phone" class="form-label">Phone No.</label>
                    </div>
                    <input type="number" class="form-control" id="phone" name="phone" required>
                </div>
                <div class="col-md-12">
                    <div class="text-left">
                        <label for="email" class="form-label">Email</label>
                    </div>
                    <input type="email" class="form-control" id="email" name="email" disabled>
                </div>
                <div class="col-md-12">
                    <div class="text-left">
                        <label for="password" class="form-label">Password</label>
                    </div>
                    <div class="input-group">
                    <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                </div>
                <div class="col-12">
                    <button id="save" class="btn btn-primary" type="submit" style="width: 50%">Save</button>
                </div>
                </form>
            </div>
            </div>
        </div>
        </div>
    </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Core theme JS-->
  <script src="js/form-validattion.js"></script>
  <script src="js/scripts.js"></script>
  <script src="js/notification.js"></script>
  <!-- * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *-->
  <!-- * *                               SB Forms JS                               * *-->
  <!-- * * Activate your form at https://startbootstrap.com/solution/contact-forms * *-->
  <!-- * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *-->
  <script src="https://cdn.startbootstrap.com/sb-forms-latest.js"></script>
  <script>
    // Retrieve user data from session storage
    const userData = JSON.parse(sessionStorage.getItem('userData'));

    // Display the username in the welcome message
    document.getElementById('username').textContent = userData.first_name + ' ' + userData.last_name;

    // Populate the profile inputs with the user data
    document.getElementById('userid').value = userData.id;
    document.getElementById('firstName').value = userData.first_name;
    document.getElementById('lastName').value = userData.last_name;
    document.getElementById('phone').value = userData.phone;
    document.getElementById('email').value = userData.email;
    document.getElementById('password').value = userData.password;

    // Handle the form submission
    document.getElementById('profileForm').addEventListener('submit', function(event) {
      event.preventDefault(); // Prevent the default form submission
      
      // Retrieve the updated values from the inputs
      const id = document.getElementById('userid').value;
      const updatedFirstName = document.getElementById('firstName').value;
      const updatedLastName = document.getElementById('lastName').value;
      const updatedPhone = document.getElementById('phone').value;
      const updatedEmail = document.getElementById('email').value;
      const updatedPassword = document.getElementById('password').value;

      // Create a new FormData object
      const formData = new FormData();
      formData.append('user_id', id);
      formData.append('first_name', updatedFirstName);
      formData.append('last_name', updatedLastName);
      formData.append('phone', updatedPhone);
      formData.append('email', updatedEmail);
      formData.append('password', updatedPassword);

      // API integration - Call the edit_user API
      fetch('http://localhost/Test%20HTML%20site/controller/apis/edit_user.php', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          console.log('API Response:', data);

          // Close the modal
          const modal = document.getElementById('profileModal');
          const bootstrapModal = bootstrap.Modal.getInstance(modal);
          bootstrapModal.hide();

          // Clear the form fields
          document.getElementById('firstName').value = updatedFirstName;
          document.getElementById('lastName').value = updatedLastName;
          document.getElementById('phone').value = updatedPhone;
          document.getElementById('email').value = updatedEmail;
          document.getElementById('password').value = updatedPassword;

          if (data.status === true) {
            showNotification('success', 'Updated successfully!');
            console.log("User details updated successfully.");
            document.getElementById('profileModal').style.display = 'none';

            // Update the user data in session storage
            userData.first_name = updatedFirstName;
            userData.last_name = updatedLastName;
            userData.phone = updatedPhone;
            userData.email = updatedEmail;
            userData.password = updatedPassword;
            sessionStorage.setItem('userData', JSON.stringify(userData));

            // Update the URL without query parameters
            const newUrl = window.location.href.split('?')[0];
            history.replaceState({}, document.title, newUrl);
          } else {
            showNotification('error', 'Something went wrong. Please try again');
            console.log("Something went wrong");
          }
        })
        .catch(error => {
          console.error('Error', error);
        });
    });
  </script>
</body>

</html>
